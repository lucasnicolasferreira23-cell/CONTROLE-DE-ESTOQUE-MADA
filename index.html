<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLE DE ESTOQUE MADA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0;}
    </style>
</head>
<body class="p-6 md:p-10 flex flex-col items-center min-h-screen">
    <div class="bg-white shadow-xl rounded-xl w-full max-w-4xl p-8 space-y-8">
        <header class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-wider">CONTROLE DE ESTOQUE MADA</h1>
            <p class="text-lg md:text-xl text-gray-500 mt-2">Gestão de sobras e chapas</p>
        </header>

        <div class="text-center text-xs text-gray-400">
            Seu ID de Usuário: <span id="user-id">Carregando...</span>
        </div>

        <div class="flex border-b border-gray-200">
            <button id="tab-cadastro" class="flex-1 py-4 text-center font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent transition-colors duration-300">
                Cadastro
            </button>
            <button id="tab-inventario" class="flex-1 py-4 text-center font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent transition-colors duration-300">
                Inventário
            </button>
        </div>

        <div id="status-message" class="hidden text-center p-3 rounded-lg font-medium transition-all duration-300"></div>
        <div id="loading-message" class="text-center p-4">
            <p class="text-gray-500">Carregando inventário...</p>
        </div>

        <section id="section-cadastro" class="space-y-6 hidden">
            <h2 class="sr-only">Cadastro de Materiais</h2>
            <form id="material-form" class="space-y-6">
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700">NOME DO MDF</label>
                    <input type="text" id="nome" name="nome" value="MDF2F" required class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="comprimento" class="block text-sm font-medium text-gray-700">COMPRIMENTO (mm)</label>
                        <input type="number" id="comprimento" name="comprimento" required class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                    </div>
                    <div>
                        <label for="largura" class="block text-sm font-medium text-gray-700">LARGURA (mm)</label>
                        <input type="number" id="largura" name="largura" required class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                    </div>
                    <div>
                        <label for="espessura" class="block text-sm font-medium text-gray-700">ESPESSURA (mm)</label>
                        <input type="number" id="espessura" name="espessura" required class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                    </div>
                </div>

                <div>
                    <label for="quantidade" class="block text-sm font-medium text-gray-700">QUANTIDADE</label>
                    <input type="number" id="quantidade" name="quantidade" required class="mt-1 block w-40 px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                </div>
                
                <div>
                    <label for="localizacao" class="block text-sm font-medium text-gray-700">LOCALIZAÇÃO</label>
                    <input type="text" id="localizacao" name="localizacao" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">TIPO</label>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input id="tipo-chapa" name="tipo" type="radio" value="Chapa" required class="focus:ring-gray-900 h-4 w-4 text-gray-900 border-gray-300">
                            <label for="tipo-chapa" class="ml-2 block text-sm font-medium text-gray-700">Chapa</label>
                        </div>
                        <div class="flex items-center">
                            <input id="tipo-sobra" name="tipo" type="radio" value="Sobra" required class="focus:ring-gray-900 h-4 w-4 text-gray-900 border-gray-300">
                            <label for="tipo-sobra" class="ml-2 block text-sm font-medium text-gray-700">Sobra</label>
                        </div>
                    </div>
                </div>

                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-800 transition-colors">
                        Cadastrar
                    </button>
                </div>
            </form>
        </section>

        <section id="section-inventario" class="space-y-6">
            <h2 class="sr-only">Inventário de Estoque</h2>

            <div class="space-y-4 md:space-y-0 md:flex md:space-x-4">
                <div class="flex-1">
                    <input type="text" id="search-nome" placeholder="Pesquisar por nome do MDF" class="block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                </div>
                <div>
                    <input type="number" id="search-espessura" placeholder="Filtrar por espessura" class="block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-900 focus:border-gray-900 sm:text-sm">
                </div>
                <div>
                    <button id="filter-btn" class="w-full md:w-auto px-4 py-2 bg-gray-900 text-white rounded-lg shadow-sm hover:bg-gray-800 transition-colors font-medium">
                        Filtrar
                    </button>
                </div>
                <div>
                    <button id="clear-filter-btn" class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors font-medium">
                        Limpar Filtro
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do MDF</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comprimento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Largura</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Espessura</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localização</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                            <th class="px-6 py-3 relative"><span class="sr-only">Ações</span></th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmAzyTEXnwJk2Kh9-yw1tboka9NRhY81M",
            authDomain: "controle-de-estoque-mada-f0252.firebaseapp.com",
            projectId: "controle-de-estoque-mada-f0252",
            storageBucket: "controle-de-estoque-mada-f0252.firebasestorage.app",
            messagingSenderId: "800947219566",
            appId: "1:800947219566:web:95075a4a51e2cf165d4a7f",
            measurementId: "G-159JVE1TL5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const form = document.getElementById('material-form');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        const searchNomeInput = document.getElementById('search-nome');
        const searchEspessuraInput = document.getElementById('search-espessura');
        const tabCadastroBtn = document.getElementById('tab-cadastro');
        const tabInventarioBtn = document.getElementById('tab-inventario');
        const sectionCadastro = document.getElementById('section-cadastro');
        const sectionInventario = document.getElementById('section-inventario');
        const statusMessage = document.getElementById('status-message');

        let userId = null;
        let inventory = [];

        signInAnonymously(auth).catch(console.error);

        onAuthStateChanged(auth, (user) => {
            if(user){
                userId=user.uid;
                document.getElementById('user-id').textContent=userId;
                listenInventory();
            }else{
                document.getElementById('user-id').textContent='Não Autenticado';
            }
        });

        function listenInventory(){
            const colRef=collection(db,'artifacts/default-app-id/public/data/inventory');
            onSnapshot(colRef,(snapshot)=>{
                inventory=[];
                snapshot.forEach(docSnap=>inventory.push({id:docSnap.id,...docSnap.data()}));
                renderInventory();
            });
        }
        
        inventoryTableBody.addEventListener('click', async (e) => {
            // Ação para o botão EXCLUIR
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                if (confirm('Tem certeza de que deseja excluir este item?')) {
                    const docRef = doc(db, 'artifacts/default-app-id/public/data/inventory', id);
                    await deleteDoc(docRef);
                    showStatus('Material excluído com sucesso!', 'bg-red-100 text-red-700');
                }
            }

            // Ação para o botão ATUALIZAR
            if (e.target.classList.contains('update-btn')) {
                const id = e.target.dataset.id;
                const itemToUpdate = inventory.find(item => item.id === id);
                
                if (itemToUpdate) {
                    const currentQuantity = itemToUpdate.quantidade;
                    const quantityUsed = prompt(`Quantidade a ser utilizada (atual: ${currentQuantity}):`);

                    if (quantityUsed !== null && !isNaN(quantityUsed) && quantityUsed.trim() !== '') {
                        const newQuantity = currentQuantity - parseInt(quantityUsed);
                        if (newQuantity >= 0) {
                            const docRef = doc(db, 'artifacts/default-app-id/public/data/inventory', id);
                            await updateDoc(docRef, { quantidade: newQuantity });
                            showStatus('Material atualizado com sucesso!', 'bg-green-100 text-green-700');
                        } else {
                            showStatus('A quantidade utilizada não pode ser maior que a quantidade atual.', 'bg-red-100 text-red-700');
                        }
                    } else if (quantityUsed !== null) {
                        showStatus('Entrada inválida. Tente novamente.', 'bg-red-100 text-red-700');
                    }
                }
            }
        });

        // Funcionalidade do botão Limpar Filtro
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        clearFilterBtn.addEventListener('click', () => {
            searchNomeInput.value = '';
            searchEspessuraInput.value = '';
            renderInventory();
        });

        // Funcionalidade do botão Filtrar
        const filterBtn = document.getElementById('filter-btn');
        filterBtn.addEventListener('click', () => {
            renderInventory();
        });

        form.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const data={
                nome:form.nome.value.toUpperCase(),
                comprimento:parseInt(form.comprimento.value),
                largura:parseInt(form.largura.value),
                espessura:parseInt(form.espessura.value),
                quantidade:parseInt(form.quantidade.value),
                tipo:form.tipo.value,
                localizacao: form.localizacao.value
            };
            await addDoc(collection(db,'artifacts/default-app-id/public/data/inventory'),data);
            form.reset();
            showStatus('Material cadastrado!','bg-green-100 text-green-700');
            switchTab('inventario');
        });

        function renderInventory(){
            const term=searchNomeInput.value.toLowerCase();
            const esp=parseInt(searchEspessuraInput.value);
            const filtered=inventory.filter(i=>i.nome.toLowerCase().includes(term)&&(isNaN(esp)||i.espessura===esp));
            inventoryTableBody.innerHTML='';
            if(filtered.length===0){
                inventoryTableBody.innerHTML=`<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhum material encontrado.</td></tr>`;
                return;
            }
            filtered.forEach(item=>{
                const tr=document.createElement('tr');
                tr.className='hover:bg-gray-50 transition-colors';
                tr.innerHTML=`
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nome}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.comprimento}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.largura}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.espessura}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.localizacao || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.tipo}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantidade}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    ${item.tipo==='Chapa'?`<button class="text-gray-600 hover:text-gray-900 mr-2 update-btn" data-id="${item.id}">Atualizar</button>`:`<button class="text-red-600 hover:text-red-900 delete-btn" data-id="${item.id}">Excluir</button>`}
                </td>`;
                inventoryTableBody.appendChild(tr);
            });
        }

        function switchTab(tab){
            if(tab==='cadastro'){sectionCadastro.classList.remove('hidden');sectionInventario.classList.add('hidden');tabCadastroBtn.classList.add('border-gray-900','text-gray-900');tabInventarioBtn.classList.remove('border-gray-900','text-gray-900');}
            else{sectionCadastro.classList.add('hidden');sectionInventario.classList.remove('hidden');tabInventarioBtn.classList.add('border-gray-900','text-gray-900');tabCadastroBtn.classList.remove('border-gray-900','text-gray-900');}
        }

        tabCadastroBtn.addEventListener('click',()=>switchTab('cadastro'));
        tabInventarioBtn.addEventListener('click',()=>switchTab('inventario'));

        function showStatus(msg,cls){
            statusMessage.textContent=msg;
            statusMessage.className=`p-3 rounded-lg font-medium ${cls}`;
            statusMessage.classList.remove('hidden');
            setTimeout(()=>statusMessage.classList.add('hidden'),3000);
        }
    </script>
</body>
</html>
